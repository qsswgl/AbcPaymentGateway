name: CI Build and Remote Deployname: CI Build & Registry Deploy



on:on:

  push:  push:

    branches: [ master ]    branches: [ master ]

  workflow_dispatch:

env:

env:  IMAGE_NAME: payment-gateway-jit

  IMAGE_NAME: payment-gateway-jit  IMAGE_TAG: ${{ github.sha }}

  IMAGE_TAG: ${{ github.sha }}

  REGISTRY_NAMESPACE: paymentpermissions:

  contents: read

jobs:

  build_and_push:jobs:

    name: Build and Push Docker Image  build_and_push:

    runs-on: ubuntu-latest    name: Build and Push image to Registry

        runs-on: ubuntu-latest

    steps:    steps:

      - name: Checkout code      - name: Checkout

        uses: actions/checkout@v4        uses: actions/checkout@v4

      

      - name: Set up Docker Buildx      - name: Set up QEMU (optional for multi-arch)

        uses: docker/setup-buildx-action@v3        uses: docker/setup-qemu-action@v2

      

      - name: Build and push to registry      - name: Login to registry

        uses: docker/build-push-action@v5        uses: docker/login-action@v2

        with:        with:

          context: .          registry: ${{ secrets.REGISTRY_URL }}

          push: true          username: ${{ secrets.REGISTRY_USERNAME }}

          tags: |          password: ${{ secrets.REGISTRY_PASSWORD }}

            ${{ secrets.REGISTRY_URL }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

            ${{ secrets.REGISTRY_URL }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest      - name: Build and push Docker image

          cache-from: type=registry,ref=${{ secrets.REGISTRY_URL }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest        uses: docker/build-push-action@v4

          cache-to: type=inline        with:

          context: .

  remote_deploy:          push: true

    name: Deploy to Remote Server          tags: |

    needs: build_and_push            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    runs-on: ubuntu-latest            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest

    

    steps:  remote_deploy:

      - name: Deploy via SSH    name: Remote Pull & Restart

        uses: appleboy/ssh-action@master    needs: build_and_push

        with:    runs-on: ubuntu-latest

          host: ${{ secrets.SSH_HOST }}    steps:

          username: ${{ secrets.SSH_USERNAME }}      - name: Run remote pull & restart via SSH

          key: ${{ secrets.SSH_PRIVATE_KEY }}        uses: appleboy/ssh-action@master

          port: ${{ secrets.SSH_PORT }}        with:

          script: |          host: ${{ secrets.SSH_HOST }}

            cd ${{ secrets.REMOTE_DIR }}          username: ${{ secrets.SSH_USERNAME }}

            docker pull ${{ secrets.REGISTRY_URL }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest          key: ${{ secrets.SSH_PRIVATE_KEY }}

            docker-compose up -d --force-recreate          port: ${{ secrets.SSH_PORT }}

            sleep 5          script: |

            curl -f http://localhost:8080/health || exit 1            set -e

            echo "Deployment successful!"            echo "Deploying image: ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

            cd "${{ secrets.REMOTE_DIR }}"
            # Pull the new image
            docker pull ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            # Ensure compose files and env are ready, then recreate containers
            if [ -f docker-compose.yml ]; then
              docker-compose pull || true
              docker-compose up -d --force-recreate --remove-orphans
            else
              # If using Docker Compose v2 (docker compose)
              docker compose pull || true
              docker compose up -d --force-recreate --remove-orphans
            fi
            echo "Waiting for health check..."
            sleep 3
            curl -fsS http://localhost:8080/health || (echo "Health check failed" && exit 1)
            echo "Remote deploy finished successfully."

      - name: Output summary
        run: |
          echo "Remote deploy attempted. Check job logs and remote host for service status."

# Required secrets (set in GitHub repository Settings -> Secrets):
# - SSH_HOST, SSH_USERNAME, SSH_PRIVATE_KEY, SSH_PORT (optional)
# - REMOTE_DIR (path on remote host where docker-compose.yml or runtime files live)
# - REGISTRY_URL, REGISTRY_NAMESPACE, REGISTRY_USERNAME, REGISTRY_PASSWORD
